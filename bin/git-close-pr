#!/usr/bin/env bash

branch=$(git rev-parse --abbrev-ref HEAD)
destination=${1:-master}

echo "[git]: fetching..."
git fetch origin $destination

echo "[git]: rebasing $destination..."
git checkout $destination || exit "couldn't checkout $destination"
git rebase

echo "[git]: rebasing $branch"
git checkout $branch
git rebase -i origin/$destination

echo "[git]: force pushing..."
git push -f

echo "[git]: waiting for ci to start..."
sleep 3
ci-wait || exit 1

echo "[git]: merging..."
git checkout $destination
git merge $branch
git push

echo "[git]: cleaning up..."
git push origin :$branch
git branch -d $branch
git nuke
